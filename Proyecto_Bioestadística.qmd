---
title: "Proyecto_Bioestadística"
format: html
editor: visual
---

## Tema: Violencia psicológica en mujeres menores de edad en el Perú (VPSMM)

Tarea 1: Gráficar la cantidad de casos de VPSMM en el año 2023 en Perú

```{r}
library(haven)
library(writexl)
library(lubridate)
library(dplyr)
library(ggplot2)
library(sf)
library(ggplot2)
library(lubridate)
```

Cargando bases de datos

```{r}
# https://portalestadistico.aurora.gob.pe/bases-de-datos-2023/
BD1_sav <- read_sav("Registro_casos 1.sav")
BD2_sav <- read_sav("Registro_casos 2.sav")
```

Quitando las variables diferentes entre ambas tablas

```{r}
columnas_tabla1 <- colnames(BD1)
columnas_tabla2 <- colnames(BD2)

# Identificar columnas diferentes
columnas_diferentes <- setdiff(union(columnas_tabla1, columnas_tabla2), intersect(columnas_tabla1, columnas_tabla2))
# Mostrar las columnas diferentes
#print(columnas_diferentes)
# Eliminando las columnas que son diferentes entre base de datos 
BD1 <- BD1[, !(names(BD1) %in% columnas_diferentes)]
BD2 <- BD2[, !(names(BD2) %in% columnas_diferentes)]
```

Juntando base de datos y agregando Semana epidemiológica

```{r}
rbind(BD1,BD2) %>%
  filter(
    TIPO_VIOLENCIA == 1 &
    EDAD_VICTIMA < 18 &
    SEXO_VICTIMA == 0
  ) %>%
  mutate(
    semana_epidemiologica = epiweek(FECHA_INGRESO),
    año_epidemiologico = ifelse(month(FECHA_INGRESO) == 12 & epiweek(FECHA_INGRESO) == 1, year(FECHA_INGRESO) + 1, year(FECHA_INGRESO))
  ) -> BD_2023
```

Graficando los casos en el 2023

```{r}
ggplot(data=BD_2023, aes(x=semana_epidemiologica))+
  geom_histogram()+
  labs(x="Semana epidemiológicas 2023",y="Cantidad de casos de VPS")+
  ggtitle(label="Cantidad de casos de VPS por semana epidemiológica en el 2023")+
  scale_x_continuous(breaks = seq(0, 52, by = 5)) +
  scale_y_continuous(breaks = seq(0, 1100, by = 200))
```

Frecuencia de casos por departamentos

```{r}
#names(BD_2023)
c_dpto<-table(BD_2023$DPTO_DOMICILIO)
c_dpto<-data.frame(c_dpto)

peru_departamentos <- st_read(dsn = "dp.shp")

names(c_dpto)[1]="CCDD"



peru_casos <-inner_join(peru_departamentos, c_dpto, by = "CCDD")

ggplot() +
  geom_sf(data = peru_casos, aes(fill = Freq)) +
  scale_fill_gradient2(name = "Casos", low = "white", mid = "pink", high = "red", midpoint = median (peru_casos$Freq)) +  # Define un color de punto medio +
  theme_minimal()


```

```{r}
library(GGally)
BD_2023 %>%
  group_by(
    semana_epidemiologica,
    SEXO_AGRESOR
  ) %>%
  summarise(
    casos = n(),
    edad_victima_avg = mean(as.numeric(EDAD_VICTIMA)),
    edad_agresor_avg = mean(as.numeric(EDAD_AGRESOR)),
    #TODO: Más variables
  ) %>%
  ungroup() -> BD_2023_agg

BD_2023_agg
ggpairs(BD_2023_agg)
```

```{r}
m0 = glm(casos ~ 1, family = poisson, data = BD_2023_agg)
summary(m0)
```

```{r}
m1 = glm(casos ~ edad_victima_avg, family = poisson, data = BD_2023_agg)
summary(m1)
```


```{r}
m2 = glm(casos ~ edad_victima_avg+SEXO_AGRESOR, family = poisson, data = BD_2023_agg)
summary(m2)
```